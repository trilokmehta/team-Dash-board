<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lumina - Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .glass-panel {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .glass-input {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
      }
      .glass-input:focus {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(99, 102, 241, 0.5);
        outline: none;
      }
      .fade-in {
        animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Custom Scrollbar for table */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
      }
    </style>
  </head>
  <body
    class="bg-[#0a0a0c] text-slate-200 font-sans min-h-screen selection:bg-indigo-500/30 overflow-hidden flex"
  >
    <div class="fixed top-0 left-0 w-full h-full -z-10 pointer-events-none">
      <div
        class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-600/20 blur-[120px] rounded-full"
      ></div>
      <div
        class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-600/10 blur-[120px] rounded-full"
      ></div>
    </div>

    <nav
      class="w-20 xl:w-72 border-r border-white/5 bg-black/20 backdrop-blur-xl p-4 flex flex-col gap-6 h-screen z-50"
    >
      <div
        class="flex items-center gap-3 px-2 mb-2 justify-center xl:justify-start"
      >
        <div
          class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20"
        >
          <i data-lucide="zap" class="text-white fill-white w-5 h-5"></i>
        </div>
        <span
          class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400 hidden xl:block"
          >Lumina</span
        >
      </div>
      <div class="flex flex-col gap-2 flex-1 overflow-y-auto">
        <a
          href="index.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full text-slate-500 hover:bg-white/5 hover:text-slate-300 transition-all group"
          ><i
            data-lucide="layout-dashboard"
            class="w-5 h-5 group-hover:scale-110 transition-transform"
          ></i
          ><span class="text-sm font-medium hidden xl:block">Dashboard</span></a
        >
        <a
          href="finance.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full bg-indigo-600 text-white shadow-lg shadow-indigo-600/20 transition-all"
          ><i data-lucide="trending-up" class="w-5 h-5 scale-110"></i
          ><span class="text-sm font-medium hidden xl:block">Finance</span></a
        >
        <a
          href="mywork.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full text-slate-500 hover:bg-white/5 hover:text-slate-300 transition-all group"
          ><i
            data-lucide="kanban-square"
            class="w-5 h-5 group-hover:scale-110 transition-transform"
          ></i
          ><span class="text-sm font-medium hidden xl:block">My Work</span></a
        >
        <a
          href="worklog.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full text-slate-500 hover:bg-white/5 hover:text-slate-300 transition-all group"
          ><i
            data-lucide="notebook-pen"
            class="w-5 h-5 group-hover:scale-110 transition-transform"
          ></i
          ><span class="text-sm font-medium hidden xl:block">Daily Log</span></a
        >
        <a
          href="files.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full text-slate-500 hover:bg-white/5 hover:text-slate-300 transition-all group"
          ><i
            data-lucide="folder-open"
            class="w-5 h-5 group-hover:scale-110 transition-transform"
          ></i
          ><span class="text-sm font-medium hidden xl:block"
            >Company Files</span
          ></a
        >
        <a
          href="passwords.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full text-slate-500 hover:bg-white/5 hover:text-slate-300 transition-all group"
          ><i
            data-lucide="lock"
            class="w-5 h-5 group-hover:scale-110 transition-transform"
          ></i
          ><span class="text-sm font-medium hidden xl:block"
            >IDs & Passwords</span
          ></a
        >
        <a
          href="monitoring.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full text-slate-500 hover:bg-white/5 hover:text-slate-300 transition-all group"
          ><i
            data-lucide="activity"
            class="w-5 h-5 group-hover:scale-110 transition-transform"
          ></i
          ><span class="text-sm font-medium hidden xl:block"
            >Monitoring</span
          ></a
        >
        <a
          href="chats.html"
          class="flex items-center gap-4 px-4 py-3.5 rounded-2xl w-full text-slate-500 hover:bg-white/5 hover:text-slate-300 mt-auto transition-all group"
          ><i
            data-lucide="message-square"
            class="w-5 h-5 group-hover:scale-110 transition-transform"
          ></i
          ><span class="text-sm font-medium hidden xl:block">Chats</span></a
        >
      </div>
    </nav>

    <main class="flex-1 flex flex-col h-screen overflow-hidden">
      <header
        class="h-20 px-8 flex items-center justify-between border-b border-white/5 bg-[#0a0a0c]/80 backdrop-blur-sm"
      >
        <h1 class="text-2xl font-bold text-white">Financial Overview</h1>
        <button
          onclick="toggleForm()"
          class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-xl text-sm font-medium flex items-center gap-2 transition-all shadow-lg shadow-indigo-600/20"
        >
          <i data-lucide="plus" class="w-4 h-4"></i> New Entry
        </button>
      </header>

      <div class="flex-1 overflow-y-auto p-8 fade-in relative">
        <div
          id="entry-form"
          class="hidden mb-8 glass-panel p-6 rounded-3xl border-l-4 border-indigo-500"
        >
          <h3 class="font-bold text-white mb-4">Add New Transaction</h3>
          <form
            onsubmit="addTransaction(event)"
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"
          >
            <div class="col-span-2">
              <label class="block text-xs text-slate-500 mb-1"
                >Description</label
              >
              <input
                type="text"
                id="desc"
                placeholder="e.g. Server Cost"
                required
                class="glass-input w-full rounded-xl px-3 py-2 text-sm"
              />
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Amount</label>
              <input
                type="number"
                id="amount"
                placeholder="0.00"
                required
                class="glass-input w-full rounded-xl px-3 py-2 text-sm"
              />
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1">Type</label>
              <select
                id="type"
                class="glass-input w-full rounded-xl px-3 py-2 text-sm"
              >
                <option value="debit" class="bg-slate-800">
                  Debit (Expense)
                </option>
                <option value="credit" class="bg-slate-800">
                  Credit (Income)
                </option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1"
                >Payment Mode</label
              >
              <select
                id="mode"
                class="glass-input w-full rounded-xl px-3 py-2 text-sm"
              >
                <option value="Credit Card" class="bg-slate-800">
                  Credit Card
                </option>
                <option value="Bank Transfer" class="bg-slate-800">
                  Bank Transfer
                </option>
                <option value="Cash" class="bg-slate-800">Cash</option>
                <option value="PayPal" class="bg-slate-800">PayPal</option>
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-500 mb-1"
                >Spender / Payer</label
              >
              <input
                type="text"
                id="spender"
                placeholder="e.g. Jane Doe"
                required
                class="glass-input w-full rounded-xl px-3 py-2 text-sm"
              />
            </div>
            <div class="col-span-2">
              <label class="block text-xs text-slate-500 mb-1">Notes</label>
              <input
                type="text"
                id="notes"
                placeholder="Optional details..."
                class="glass-input w-full rounded-xl px-3 py-2 text-sm"
              />
            </div>
            <div
              class="md:col-span-2 lg:col-span-4 flex justify-end gap-2 mt-2"
            >
              <button
                type="button"
                onclick="toggleForm()"
                class="px-4 py-2 rounded-xl text-slate-400 hover:bg-white/5 text-sm"
              >
                Cancel
              </button>
              <button
                type="submit"
                class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm font-medium"
              >
                Save Transaction
              </button>
            </div>
          </form>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div
            class="glass-panel p-6 rounded-3xl bg-emerald-500/5 border-emerald-500/20"
          >
            <div class="flex justify-between items-start">
              <div>
                <p class="text-emerald-400 text-sm font-medium mb-1">
                  Total Income
                </p>
                <h3 id="total-income" class="text-3xl font-bold text-white">
                  $0
                </h3>
              </div>
              <div class="p-2 bg-emerald-500/10 rounded-lg text-emerald-400">
                <i data-lucide="arrow-up-right" class="w-6 h-6"></i>
              </div>
            </div>
          </div>
          <div
            class="glass-panel p-6 rounded-3xl bg-rose-500/5 border-rose-500/20"
          >
            <div class="flex justify-between items-start">
              <div>
                <p class="text-rose-400 text-sm font-medium mb-1">
                  Total Expenses
                </p>
                <h3 id="total-expense" class="text-3xl font-bold text-white">
                  $0
                </h3>
              </div>
              <div class="p-2 bg-rose-500/10 rounded-lg text-rose-400">
                <i data-lucide="arrow-down-left" class="w-6 h-6"></i>
              </div>
            </div>
          </div>
          <div
            class="glass-panel p-6 rounded-3xl bg-indigo-500/5 border-indigo-500/20"
          >
            <div class="flex justify-between items-start">
              <div>
                <p class="text-indigo-400 text-sm font-medium mb-1">
                  Net Balance
                </p>
                <h3 id="net-balance" class="text-3xl font-bold text-white">
                  $0
                </h3>
              </div>
              <div class="p-2 bg-indigo-500/10 rounded-lg text-indigo-400">
                <i data-lucide="wallet" class="w-6 h-6"></i>
              </div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
          <div class="lg:col-span-2 glass-panel p-6 rounded-3xl">
            <h3 class="text-lg font-bold text-white mb-6">
              Income vs Expenses
            </h3>
            <div class="h-64 w-full"><canvas id="financeChart"></canvas></div>
          </div>
          <div class="lg:col-span-1 glass-panel p-6 rounded-3xl flex flex-col">
            <h3 class="text-lg font-bold text-white mb-6">
              Spending Breakdown
            </h3>
            <div
              id="category-list"
              class="flex-1 space-y-4 overflow-y-auto pr-2 custom-scrollbar"
            >
              <div class="text-slate-500 text-sm text-center">Loading...</div>
            </div>
          </div>
        </div>

        <div class="glass-panel rounded-3xl overflow-hidden">
          <div
            class="p-6 border-b border-white/5 flex justify-between items-center"
          >
            <h3 class="font-bold text-white">Recent Transactions</h3>
            <button
              onclick="fetchTransactions()"
              class="text-slate-500 hover:text-white"
            >
              <i data-lucide="refresh-cw" class="w-4 h-4"></i>
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-slate-400">
              <thead
                class="bg-white/5 text-xs uppercase font-semibold text-slate-500"
              >
                <tr>
                  <th class="px-6 py-4">Description</th>
                  <th class="px-6 py-4">Spender</th>
                  <th class="px-6 py-4">Mode</th>
                  <th class="px-6 py-4">Date</th>
                  <th class="px-6 py-4">Notes</th>
                  <th class="px-6 py-4 text-right">Amount</th>
                </tr>
              </thead>
              <tbody id="tx-table-body" class="divide-y divide-white/5">
                <tr>
                  <td colspan="6" class="px-6 py-4 text-center text-slate-600">
                    Loading data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
    <script>
      // Init
      lucide.createIcons();

      // Supabase Config
      const SUPABASE_URL = "https://jwrgsmluqhqlxizsuyzc.supabase.co";
      const SUPABASE_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3cmdzbWx1cWhxbHhpenN1eXpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNjQ1OTYsImV4cCI6MjA4Mjk0MDU5Nn0.daGg1TXP3JjrkQeEodEPBY97ThfFRH3cppETLTWUl8Y";
      if (!window.financeClient) {
    window.financeClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
}
      let chartInstance = null;

      // --- Functions ---

      function toggleForm() {
        document.getElementById("entry-form").classList.toggle("hidden");
      }

async function fetchTransactions() {
  // Changed 'supabase' to 'financeClient'
  const { data, error } = await window.financeClient
    .from("transactions")
    .select("*")
    .order("date", { ascending: false });
    
  if (error) {
    console.error("Fetch Error:", error.message);
  } else {
    updateUI(data);
    updateChart(data);
  }
}

      function updateUI(data) {
        // 1. Calculate Totals
        let income = 0,
          expense = 0;
        const categories = {};

        data.forEach((tx) => {
          const amt = parseFloat(tx.amount);
          if (tx.type === "credit") {
            income += amt;
          } else {
            expense += amt;
            // Track category for expenses
            const cat = tx.description.split(" ")[0] || "Misc"; // Simple heuristic if category col is empty
            categories[cat] = (categories[cat] || 0) + amt;
          }
        });

        document.getElementById(
          "total-income"
        ).innerText = `$${income.toLocaleString()}`;
        document.getElementById(
          "total-expense"
        ).innerText = `$${expense.toLocaleString()}`;
        document.getElementById("net-balance").innerText = `$${(
          income - expense
        ).toLocaleString()}`;

        // 2. Render Table
        const tbody = document.getElementById("tx-table-body");
        tbody.innerHTML = data
          .map(
            (tx) => `
                <tr class="hover:bg-white/5 transition-colors group">
                    <td class="px-6 py-4 font-medium text-white">${
                      tx.description
                    }</td>
                    <td class="px-6 py-4"><div class="flex items-center gap-2"><div class="w-6 h-6 rounded-full bg-indigo-500/20 text-indigo-400 flex items-center justify-center text-[10px] font-bold">${
                      tx.spender
                        ? tx.spender.substring(0, 2).toUpperCase()
                        : "NA"
                    }</div> ${tx.spender}</div></td>
                    <td class="px-6 py-4"><span class="px-2 py-1 rounded bg-white/5 text-xs border border-white/5">${
                      tx.payment_mode || "-"
                    }</span></td>
                    <td class="px-6 py-4 text-slate-500">${new Date(
                      tx.date
                    ).toLocaleDateString()}</td>
                     <td class="px-6 py-4 text-xs text-slate-600 max-w-[150px] truncate" title="${
                       tx.notes
                     }">${tx.notes || ""}</td>
                    <td class="px-6 py-4 text-right font-bold ${
                      tx.type === "credit"
                        ? "text-emerald-400"
                        : "text-rose-400"
                    }">
                        ${tx.type === "credit" ? "+" : "-"}$${parseFloat(
              tx.amount
            ).toLocaleString()}
                    </td>
                </tr>
            `
          )
          .join("");

        // 3. Render Spending Breakdown
        const catList = document.getElementById("category-list");
        const sortedCats = Object.entries(categories).sort(
          (a, b) => b[1] - a[1]
        ); // Sort by highest spend

        if (sortedCats.length === 0) {
          catList.innerHTML =
            '<div class="text-slate-500 text-center text-sm">No expenses recorded.</div>';
        } else {
          catList.innerHTML = sortedCats
            .map(([cat, amt]) => {
              const pct = Math.round((amt / expense) * 100);
              return `
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-slate-300">${cat}</span>
                            <span class="text-slate-400">$${amt.toLocaleString()}</span>
                        </div>
                        <div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden">
                            <div class="h-full bg-rose-500/50 rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>`;
            })
            .join("");
        }
      }

      function updateChart(data) {
        // Group by month
        const months = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "May",
          "Jun",
          "Jul",
          "Aug",
          "Sep",
          "Oct",
          "Nov",
          "Dec",
        ];
        const incomeData = new Array(12).fill(0);
        const expenseData = new Array(12).fill(0);

        data.forEach((tx) => {
          const date = new Date(tx.date);
          const monthIdx = date.getMonth();
          if (tx.type === "credit")
            incomeData[monthIdx] += parseFloat(tx.amount);
          else expenseData[monthIdx] += parseFloat(tx.amount);
        });

        const ctx = document.getElementById("financeChart").getContext("2d");

        if (chartInstance) chartInstance.destroy();

        chartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: months,
            datasets: [
              {
                label: "Income",
                data: incomeData,
                backgroundColor: "#10b981",
                borderRadius: 4,
              },
              {
                label: "Expense",
                data: expenseData,
                backgroundColor: "#f43f5e",
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                grid: { color: "rgba(255,255,255,0.05)" },
                ticks: { color: "#94a3b8" },
              },
              x: { grid: { display: false }, ticks: { color: "#94a3b8" } },
            },
            plugins: { legend: { labels: { color: "#e2e8f0" } } },
          },
        });
      }

      async function addTransaction(e) {
  e.preventDefault();
  const desc = document.getElementById("desc").value;
  const amount = document.getElementById("amount").value;
  const type = document.getElementById("type").value;
  const mode = document.getElementById("mode").value;
  const spender = document.getElementById("spender").value;
  const notes = document.getElementById("notes").value;

  // Changed 'supabase' to 'financeClient'
  const { error } = await window.financeClient.from("transactions").insert([
    {
      description: desc,
      amount: parseFloat(amount),
      type: type,
      payment_mode: mode,
      spender: spender,
      notes: notes,
      date: new Date().toISOString() // Good practice to include the date explicitly
    },
  ]);

  if (error) {
    alert("Error saving: " + error.message);
  } else {
    e.target.reset();
    toggleForm();
    fetchTransactions();
  }
}

      // Load Data
      fetchTransactions();
    </script>
  </body>
</html>
